<section data-ng-controller="ConversationsSearchController" data-ng-init="init()">
    <div class="page-header">
        <h1>Search Conversations</h1>
    </div>

    <form name="frmSearch" role="form" data-ng-submit="find()">
        <div class="row form-wrapper">
            <div class="col-sm-4">
                <label>Conversation With:</label>
                <div class="input-group">
                    <div class="input-group-btn btn-group">
                        <a class="btn btn-default" data-ng-click="changeConversationWith('User')"
                           data-ng-disabled="query.conversationWith === 'User'">User</a>
                        <a class="btn btn-default" data-ng-click="changeConversationWith('Contact')"
                           data-ng-disabled="query.conversationWith === 'Contact'">Contacts</a>
                        <a class="btn btn-default" data-ng-click="changeConversationWith('Guest')"
                           data-ng-disabled="query.conversationWith === 'Guest'">Guests</a>
                    </div>
                </div>
            </div>
            <div class="col-sm-4">
                <label>Filter:</label>
                <ng-switch on="query.conversationWith">
                    <!-- User selection -->
                    <p class="input-group" data-ng-switch-when="User">
                        <span class="input-group-addon">User</span>
                        <select data-ng-change="selectUser()" class="form-control" data-ng-model="query.userId"
                                data-ng-options="user._id as user.fullName for user in users">
                            <option value="">-- All Users --</option>
                        </select>
                    </p>
                    <!-- Guest selection -->
                    <p class="input-group" data-ng-switch-when="Guest">
                        <span class="input-group-addon">Guest</span>
                        <input type="text" class="form-control"
                               data-ng-model="query.guest"
                               uib-typeahead="guest as guest.fullName for guest in findGuests($viewValue)">
                    </p>
                    <!-- Contact selection -->
                    <p class="input-group" data-ng-switch-when="Contact">
                        <span class="input-group-addon">Contact</span>
                        <select data-ng-change="selectContact()" class="form-control" data-ng-model="query.contactId"
                                data-ng-options="contact._id as contact.fullName for contact in contacts">
                            <option value="">-- All Contacts --</option>
                        </select>
                    </p>
                </ng-switch>
            </div>
            <div class="col-sm-4">
                <div class="form-group">
                    <label>Text Search:</label>
                    <input type="text" class="form-control" data-ng-model="query.freeText" disabled placeholder="Disabled for now">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-block btn-default" data-ng-disabled="frmSearch.$invalid">
                        <i class="glyphicon glyphicon-search"></i> Search Conversations
                    </button>
                </div>
            </div>
        </div>
        <div class="row form-wrapper">
            <div class="col-md-12 text-right">
                <pagination data-ng-show="totalCount" data-total-items="totalCount" data-ng-model="currentPage"
                            data-boundary-links="false" data-max-size="5" data-items-per-page="25" data-ng-change="find()"></pagination>
            </div>
        </div>
    </form>

    <div class="text-center" ng-if="!conversationsQuery.$resolved">
        <img src="/app/core/img/loaders/loader.gif" alt="Loading">
    </div>

    <table data-ng-show="conversations" class="table table-hover">
        <thead>
            <tr>
                <th>Recipient</th>
                <th>Subject</th>
                <th>Update Time (Your timezone)</th>
            </tr>
        </thead>
        <tbody>
            <tr data-ng-repeat="conversation in conversations">
                <td>
                   <span data-ng-if="conversation.conversationWith === 'Guest'" data-ng-bind="conversation.guest.fullName"></span>
                   <span data-ng-if="conversation.conversationWith === 'User'" data-ng-bind="account.name"></span>
                   <span data-ng-if="conversation.conversationWith === 'Contact'" data-ng-bind="conversation.contact.fullName"></span>
                </td>
                <td><a data-ng-click="openConversation(conversation)" data-ng-bind="conversation.subject || 'Unknown subject'"></a></td>
                <td data-ng-bind="conversation.lastUpdatedAt | date: 'short'"></td>
            </tr>
        </tbody>
    </table>
</section>
