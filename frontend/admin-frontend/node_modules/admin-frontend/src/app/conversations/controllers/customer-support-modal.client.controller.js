'use strict';

angular.module('conversations').controller('CustomerSupportModalController',  [
    '$scope',
    'notify',
    'CommonService',
    'modalInput',
    '$uibModalInstance',
    '$http',
    'Authentication',
    'User',
    'Accounts',
    'AppConfig',
    function ($scope, notify, CommonService, modalInput, $uibModalInstance, $http, Authentication, User, Accounts, AppConfig) {

        $scope.employee = Authentication.getEmployee();

        $scope.account = modalInput.account || {};
        if ($scope.account._id){
            $scope.users = User.query({accountId:$scope.account._id, fields:'fullName email'}, function(response){
                if (modalInput.userEmail) {
                    $scope.userEmail = modalInput.userEmail;
                } else if (modalInput.userId){
                    $scope.userEmail = (_.find(response.results, {'_id': modalInput.userId}) || {}).email;
                } else {
                    $scope.userEmail = (_.first(response.results) || {}).email;
                }
            });
            if (!$scope.account.name){
                $scope.account = Accounts.get({accountId: $scope.account._id, fields:'name'});
            }
        }

        $scope.uneditablePrivateNote = modalInput.uneditablePrivateNote;
        $scope.privateNote = modalInput.privateNote;
        $scope.publicNote = modalInput.publicNote;
        $scope.subject = modalInput.subject;

        $scope.save = function() {
            var privateNote = Authentication.getEmployee().username + ':\n';
            if ($scope.privateNote){
                privateNote += $scope.privateNote;
            }
            if ($scope.uneditablePrivateNote){
                if (privateNote) privateNote += '\n';
                privateNote += $scope.uneditablePrivateNote;
            }

            var baseApiOldUrl = AppConfig.API_OLD_URL;

            $http.post(baseApiOldUrl + 'send-to-zendesk', {
                accountId: $scope.account._id,
                userEmail: $scope.userEmail,
                subject: $scope.subject,
                privateNote: privateNote,
                publicNote: $scope.publicNote
            }).success(function(){
                notify({
                    message: 'Sent to customer support',
                    classes: 'alert-success'
                });
                $uibModalInstance.close();
            }).error(function(){
                notify({
                    message: 'Error occurred.',
                    classes: 'alert-danger'
                });
            });
        };

    }]);
