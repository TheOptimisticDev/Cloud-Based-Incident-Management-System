'use strict';

//Shifts service used to communicate Shifts REST endpoints
angular.module('team').factory('TeamUpdates', [
    'TeamUpdatePost',
    '$uibModal',
    'store',
    '$rootScope',
    function(TeamUpdatePost, $uibModal, store, $rootScope) {
        return {
            registerListeners: registerListeners,
            popup: popup,
            popupIfHaveNotRecently: popupIfHaveNotRecently
        };

        ////////////////////

        function registerListeners(){
            $rootScope.$on('employee.loaded', popupIfHaveNotRecently);
            $rootScope.$on('employee.checkedIn', onCheckedIn);
            $rootScope.$on('employee.checkedOut', onCheckedOut);
        }

        function onCheckedIn(){
            popup('checkIn');
        }
        function onCheckedOut(){
            popup('checkOut');
        }

        function popup(action){
            TeamUpdatePost.query({mode: 'unseen', action: action}, function(updates){
                store.set('lastCheckedForTeamUpdates', moment().format());
                if (updates.length){
                    $uibModal.open({
                        templateUrl: 'app/team/views/team-updates.client.view.html',
                        size: 'lg',
			windowClass: 'team-updates-modal',
                    });
                }
            });
        }

        function popupIfHaveNotRecently(){
            //only if logged in
            if (!$rootScope.employee) return;

            //check when is the last time
            var lastChecked = store.get('lastCheckedForTeamUpdates');
            //if it is more than 6 hours ago, check again
            if (!lastChecked || moment(lastChecked).isBefore(moment().subtract(2, 'hours'))){
                popup('periodical');
            }
        }
    }
]);
