/*global google, MarkerClusterer */
'use strict';

// Listing controller
angular.module('listings').controller('MapController', ['$scope', '$stateParams', '$location', 'Listing',
	function($scope, $stateParams, $location, Listing) {

		var listings = [];

		var fields = 'address.lng address.lat isListed';

		var map;

		var infoWindow = new google.maps.InfoWindow({
			content: ''
		});

		// Find a list of Listing
		$scope.find = function () {
			// Reset pagination and list
			$scope.listings = null;

			Listing.query({
				fields: fields,
				q: this.query,
				active: true,
				limit: 0
			}, function (result) {
				listings = result.listings;

				if (map) $scope.$emit('mapInitialized', map);

			});
		};

		$scope.mapMarkers = [];


		var markerClicked = function(marker){
			return function(){
				var listing = Listing.get({listingId: marker._id}, function(){
					infoWindow.content = '<h4><a href="/listings/' + listing._id + '/preferences/general">' + listing.title + '</a></h4><p>' + listing.address.full + '</p><p>' + listing.propertyType + '</p>';
					infoWindow.open(map, marker);
				});
			};
		};

		$scope.$on('mapInitialized', function(event, evtMap) {
			map = evtMap;

			_.each(listings, function (listing) {
				var marker = new google.maps.Marker({
					map: map,
					draggable: false,
					position: new google.maps.LatLng(listing.address.lat, listing.address.lng),
					_id: listing._id,
					icon: (function(){ return listing.isListed ? '//chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|00ff00' : '//chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|FE7569'; })()
				});

				google.maps.event.addListener(marker, 'click', markerClicked(marker));

				$scope.mapMarkers.push(marker);
			});
			$scope.markerClusterer = new MarkerClusterer(map, $scope.mapMarkers);
		});

	}
]);
