'use strict';

// listings preferences controller
angular.module('listings').controller('ListingPostBookingController', [
	'$scope',
	'$state',
	'$stateParams',
	'$location',
	'notify',
	'Menus',
	'Authentication',
	'Listing',
	'Accounts',
    'dataFallback',
	function($scope, $state, $stateParams, $location, notify, Menus, Authentication, Listing, Accounts, dataFallback) {

        function getListing(callback) {
            dataFallback($scope, 'listing', function(id, listing) {
                if(listing) {
                    $scope.listing = listing;
                    return callback();
                } else if(id) {
                    $scope.listing = Listing.get({
                        listingId: id,
                        fields: '_id accountId postBookingService'
                    }, callback);
                }
            });
        }

        function getAccount() {
            if (!$scope.account || !$scope.account.postBookingService){
                $scope.account = Accounts.get({accountId: $scope.listing.accountId, fields: '_id postBookingService'});
            }
        }

		$scope.init = function(){
            getListing(getAccount);
		};

		$scope.saveForm = function(frm, limitTo) {
            if (frm && frm.$invalid) return;

            if (!_.isArray(limitTo)) limitTo = [limitTo];
            var obj = {};
            _.each(limitTo, function(path){
                _.set(obj, path, _.get($scope.listing, path));
            });

			Listing.save({
				listingId: $scope.listing._id
			}, obj, function() {
				notify({
					message: 'Saved successfully',
					classes: 'alert-success'
				});
                if (frm) {
                    frm.$setPristine();
                }
			}, function(){
                notify({
                    message: 'Save failed',
                    classes: 'alert-danger'
                });
                if (frm) {
                    frm.$setPristine();
                }
            });
		};

        $scope.setValue = function(key, value, frm){
            _.set($scope.listing, key, value);
            if (frm) {
                frm.$setDirty();
            }
        };
	}
]);
