'use strict';

// Listings controller
angular.module('listings').controller('ListingIntegrationsController', [
    '$scope',
    '$stateParams',
    'notify',
    'Listing',
    'Integrations',
	function($scope, $stateParams, notify, Listing, Integrations) {

        var self = this;

        self.init = function(){
            async.parallel({
                listing: function(done) {
                    self.listing = Listing.get({listingId: $stateParams.listingId, fields: 'integrations'}, function() {
                        done();
                    }, done);
                },

                integrations: function(done){
                    Integrations.query({accountId: $scope.listing.accountId, sort: '-platform', fields: 'nickname platform'}, function(response){
                        done(null, response.results);
                    }, done);
                }
            }, function(err, results){
                if (err){
                    notify({message:'Error', classes: 'alert-danger'});
                    return;
                }

                var existingIntegrationIds = _.map(self.listing.integrations, '_id');

                self.unconnectedIntegrations = _.reject(results.integrations, function(integration){
                    return existingIntegrationIds.indexOf(integration._id) !== -1;
                });

              self.onlyRU = _.filter(self.unconnectedIntegrations, function(integration){
                return integration.platform === "rentalsUnited";

              });

            });
        };

        self.addIntegration = function(integration){
            Listing.addIntegration({listingId: $stateParams.listingId}, {
                _id: integration._id
            }, self.init);
        };

	}
]);
