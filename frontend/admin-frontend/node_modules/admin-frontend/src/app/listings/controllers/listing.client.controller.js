'use strict';

// Listing controller
angular.module('listings').controller('ListingController', ListingController);


/** @ngInject **/
function ListingController($scope, $stateParams, $location, $uibModal, Authentication, Menus, Listing, Accounts, Integrations, notify, $state, ListingsModalsService){
	// Expose state service
	$scope.$state = $state;

	// Set sidebar details
	$scope.listingSidebar = Menus.getMenu('listing');

	// Expose the authentication service
	$scope.authentication = Authentication;

	var listingAccount = null;

	// Load listing
	Listing.get({
		listingId: $stateParams.listingId
	}, function(listing){
		// Expose to view
		$scope.listing = listing;

    $scope.listing.pendingTasks.reverse();

		// Load Account
		// todo: include in api, if included in fields
		$scope.account = Accounts.getApi2({
			accountId: listing.accountId,
			fields: 'name active plan'
		}, function(res){
			$scope.account.plan = res.plan;
		});


		/* If (listing.integrations && listing.integrations.length){
		 var ids = _.map($scope.listing.integrations, '_id');
		 _.each(ids, function(integrationId){
		 Integrations.get({integrationId: integrationId, fields:'nickname'}, function(integrations){
		 _.each(integrations, function(integration){
		 _.find($scope.listing.integrations, {'_id': integration._id}).nickname = integration.nickname;
		 });
		 });
		 });
		 }*/
	});


	// Open gallery with listing photos
	$scope.openGallery = function(listing){
		ListingsModalsService.openListingGalleryModal(listing._id);
	};

	// Save listing
	$scope.save = function(listing, form, cb){
		// Can use the listing from the scope, without giving one.
		listing = listing || $scope.listing;

		if(!listing){
			return notify({
				message: 'Bad request',
				classes: 'alert-danger'
			});
		}
		if(form && !form.$valid){
			return notify({
				message: 'Invalid form',
				classes: 'alert-danger'
			});
		}

		if(!listing.$save){
			listing = new Listing(listing);
		}
		listing.$save(function(){
			notify({
				message: 'Saved!',
				classes: 'alert-success'
			});
			if(form) form.$setPristine();

			listing.account = listingAccount;
			$scope.listing = listing;
		}, function(response){
			var extraMessage = response.data ? response.data.message : '';
			notify({
				message: 'Saving failed: ' + response.status + ': ' + response.statusText + ': ' + extraMessage,
				classes: 'alert-danger'
			});
		}).finally(function(){
			if(cb) return cb();
		});
	};

	// Open log modal
	$scope.openLogModal = function(category){
		var listing = $scope.listing;
		$uibModal.open({
			size: 'lg',
			windowClass: 'log-modal',
			templateUrl: 'app/accounts/views/modals/log.client.view.html',
			controller: 'LogModalController',
			resolve: {
				formData: function(){
					return {
						category: category,
						account: listing.account,
						listing: listing
					};
				}
			}
		});
	};
}
