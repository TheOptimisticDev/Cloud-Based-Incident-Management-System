'use strict';

// Listings controller
angular.module('listings').controller('ListingLogsController', ListingLogsController);

function ListingLogsController($scope, Accounts){

	$scope.limit = 50;
	$scope.currentPage = 1;
	$scope.categories = [];
	$scope.isLoading = false;

	$scope.find = findHandler;

	$scope.expand = false;

	////////////////////////

	toggleLoading();
	Accounts.categories({
		accountId: $scope.account._id,
		listingId: $scope.listing._id
	}, function(categories){
		categories = categories || []; // Promising array
		var filteredCategories = _.filter(categories, function(elem){
			return typeof elem === typeof '' ? elem : '';
		});
		$scope.categories = _.map(filteredCategories, function(category){
			return {name: category};
		});
		toggleLoading();
	});

	function toggleLoading(){
		$scope.isLoading = !$scope.isLoading;
	}

	function findHandler(){

		toggleLoading();
		// Reset pagination and list
		$scope.logs = null;

		var selectedCategories = [];
		_.each($scope.categories, function(category){
			if(category.active) selectedCategories.push(category.name);
		});

		Accounts.logs({
			accountId: $scope.account._id,
			listingFilterEnabled: true,
			listingId: $scope.listing._id,
			categories: selectedCategories,
			skip: ($scope.currentPage - 1) * $scope.limit,
			limit: $scope.limit
		}, function(result){
			toggleLoading();
			$scope.logs = result.logs;
			$scope.totalCount = result.totalCount;
		});
	}



}
