'use strict';

// Listing controller
angular.module('listings').controller('ListingPropertyController', [
    '$scope',
    'Accounts',
    'User',
    'Contact',
    function($scope, Account, User, Contact) {
        // Copy listing from parent scope
        $scope.init = function() {
            $scope.listing = angular.copy($scope.$parent.listing);

            Account.get({accountId: $scope.listing.accountId, fields: 'customFields'}, function(account){
                $scope.customFields = _.filter(account.customFields || [], {'object': 'listing'});

                var userField = _.find($scope.customFields, {'type': 'user'});
                if (userField){
                    User.query({accountId: $scope.listing.accountId, fields:'fullName'}, function(users){
                        _.each($scope.customFields, function(field){
                            if (field.type==='user' && field.value){
                                var user = _.find(users.results, {'_id': field.value});
                                field.displayValue = user ? user.fullName : 'Unknown user';
                            }
                        });
                    });
                }
                var contactField = _.find($scope.customFields, {'type': 'contact'});
                if (contactField){
                    Contact.query({accountId: $scope.listing.accountId, fields:'fullName'}, function(contacts){
                        _.each($scope.customFields, function(field){
                            if (field.type==='contact' && field.value){
                                var contact = _.find(contacts.results, {'_id': field.value});
                                field.displayValue = contact ? contact.fullName : 'Unknown contact';
                            }
                        });
                    });
                }

                _.each($scope.listing.customFields || [], function(reservationField){
                    var field = _.find($scope.customFields, {'_id': reservationField.fieldId});
                    if (field){
                        field.value = reservationField.value;
                    } else {
                        //deleted field, should not happen, because when deleting a custom field, it deletes the data as well.
                    }
                });
            });
        };
    }
]);
