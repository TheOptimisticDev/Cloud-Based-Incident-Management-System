'use strict';

angular.module('listings').controller('ListingCalendarAvailabilityModalController', [
    '$scope',
    'listingId',
    'listing',
    'formData',
    '$uibModalInstance',
    'notify',
    'CommonService',
    'Listing',
    'ListingCalendar',
    function($scope, listingId, listing, formData, $uibModalInstance, notify, CommonService, Listing, ListingCalendar) {

        function validateDates(frm) {
            if(!($scope.formData.from && $scope.formData.to)) {
                return frm.$setValidity(false);
            }
            if (!moment($scope.formData.from).isValid() || !moment($scope.formData.to).isValid()){
                return frm.$setValidity(false);
            }
            if(moment($scope.formData.from).toDate > moment($scope.formData.to).toDate) {
                return frm.$setValidity(false);
            }
        }

        $scope.init = function() {
            if (listing && listing.prices) {
                $scope.listing = listing;
            } else {
                $scope.listing = Listing.get({listingId: listingId, fields: 'prices'});
            }

            $scope.formData = {
                from:      formData.from ? moment(formData.from).toDate() : new Date(),
                to:        formData.to ? moment(formData.to).toDate() : new Date(),
                availability: _.has(formData.availability) ? formData.availability : true,
                price:     formData.price || null
            };
        };

        $scope.save = function(frm) {
            validateDates(frm);
            if (frm.$invalid) return;

            var data = {
                listings:  $scope.listing._id,
                from:      moment($scope.formData.from).format('YYYY-MM-DD'),
                to:        moment($scope.formData.to).format('YYYY-MM-DD'),
                status:    $scope.formData.availability ? 'available' : 'unavailable'
            };

            if ($scope.formData.availability){
                data.price = $scope.formData.price;
            }

            var calendar = ListingCalendar.update(data, function() {
                notify({message: 'Changing calendar status saved successfully', classes: 'alert-success'});
                $uibModalInstance.close(true);
            }, function() {
                notify({message: 'Changing calendar status saving failed. Please try again.', classes: 'alert-info'});
                $scope.disableButtons = false;
                frm.$setPristine();
            });
        };
    }
]);
