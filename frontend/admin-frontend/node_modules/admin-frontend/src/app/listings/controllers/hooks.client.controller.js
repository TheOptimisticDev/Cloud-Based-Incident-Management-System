'use strict';

// listings preferences controller
angular.module('listings').controller('ListingHooksController', [
	'$scope',
	'SweetAlert',
	'Listing',
	function($scope, SweetAlert, Listing) {

        var self = this;


        var sendUpdateListingRequest = function(data){
            Listing.save({listingId: $scope.listing._id}, data, function(){
                SweetAlert.swal({
                    title: 'Success',
                    type: 'success'
                });
            }, function(err){
                SweetAlert.swal({
                    title: 'Error',
                    text: err,
                    type: 'error'
                });
            });
        };

        self.toggleHooksFeature = function(){
            if (_.get($scope, 'listing.pms.automation.hooks.active')) {
                //enabling
                //show message
                SweetAlert.swal({
                    title: 'Enabling hooks...',
                    showConfirmButton: false
                });
                //send request
                sendUpdateListingRequest({ pms: { automation: { hooks: { active: true }}}});

            } else {
                //disabling
                SweetAlert.swal({
                    title: 'Are You Sure?',
                    text: 'Disabling hooks will cancel all the future hooks',
                    type: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#DD6B55',
                    confirmButtonText: 'Disable hooks',
                    cancelButtonText: 'Cancel',
                    closeOnConfirm: true,
                    closeOnCancel: true
                }, function(isConfirm) {
                    if (isConfirm) {
                        //disabling
                        SweetAlert.swal({
                            title: 'Disabling hooks...',
                            showConfirmButton: false
                        });
                        sendUpdateListingRequest({ pms: { automation: { hooks: { active: false }}}});
                    } else {
                        //aborted. set the geatures back to normal
                        _.set($scope, 'listing.pms.automation.hooks.active', true);
                    }
                });
            }
        };

	}
]);
