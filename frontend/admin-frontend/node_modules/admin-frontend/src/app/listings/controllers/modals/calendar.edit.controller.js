'use strict';

angular.module('listings').controller('ListingCalendarEditCtrl', [
    'event',
    'listingIds',
    'ListingCalendar',
    '$uibModalInstance',
    function(event, listingIds, ListingCalendar, $uibModalInstance) {

        var self = this;

        self.init = function(){
            self.from = moment(event.start || event.date, 'YYYY-MM-DD').toDate();
            self.to = moment(event.end || event.date, 'YYYY-MM-DD').toDate();
            self.price = event.price;
            self.currency = event.currency;
            self.availability = event.status === 'available';
            self.note = event.note;
            if (event.note){
                self.addNote = true;
            }
        };

        self.changeNote = function(frm){
            if (!self.addNote){
                self.note = '';
            }
            frm.note.$setDirty();
        };

        self.submit = function(frm){
            var data = {
                listings: listingIds,
                from: moment(self.from).format('YYYY-MM-DD'),
                to: moment(self.to).format('YYYY-MM-DD')
            };
            if (frm.available.$dirty){
                data.status = self.availability ? 'available' : 'unavailable';
            }
            if (frm.price.$dirty){
                data.price = self.price;
            }
            if (frm.note.$dirty){
                data.note = self.note;
            }
            ListingCalendar.update(data, function(){
                $uibModalInstance.close({
                    status: 'success'
                });
            }, function(err){
                self.error = err;
                frm.$setPristine();
            });
        };

    }
]);
