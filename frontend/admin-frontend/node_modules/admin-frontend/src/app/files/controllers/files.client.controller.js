'use strict';

// Templates controller
angular.module('files').controller('FilesController', [
    '$scope',
    'Authentication',
    'Filepicker',
    'notify',
    'Files',
    'CommonService',
	function($scope, Authentication, Filepicker, notify, Files, CommonService) {
        var employeeName = Authentication.getEmployee().username;

        var accountId = $scope.account ? $scope.account._id : $scope.listing ? $scope.listing.accountId : null;
        var listingId = $scope.listing ? $scope.listing._id : null;

        $scope.upload = function(){
            Filepicker.pickAndStore({}, {}, function(files){
                //extend files with metadata
                //go over each file (file picker can upload several files)
                _.each(files, function(file){
                    file.createdAt = new Date();
                    file.createdBy = employeeName;
                    file.accountId = accountId;
                    if (listingId) file.listingId = listingId;

                    Files.save(file, function() {
                        notify({
                            message: 'Contact updated',
                            classes: 'alert-success'
                        });
                        $scope.find();
                    }, function(){
                        notify({
                            message: 'Error',
                            classes: 'alert-danger'
                        });
                    });
                });
            });
        };


        $scope.find = function(){
            if (accountId){
                $scope.accountFiles = Files.query({
                    accountId: accountId
                });
            }

            if (listingId){
                // Get listing files
                $scope.listingFiles = Files.query({
                    listingId: listingId
                });
            }
        };

		// Remove existing file
		$scope.remove = function(file) {
            CommonService.confirm().then(function() {
                file.$remove(function() {
                    notify({
                        message: 'File removed successfully',
                        classes: 'alert-success'
                    });
                    $scope.find();
                }, function() {
                    notify({
                        message: 'Failed to remove file',
                        classes: 'alert-danger'
                    });
                });
            });
		};

        // Change label
        $scope.label = function(file) {
            var label = prompt('Enter a new label');
            file.label = label;
            file.$update(function() {
                $scope.find();
            }, function(errorResponse) {
                $scope.error = errorResponse.data.message;
            });
        };

		// Update existing file
		$scope.update = function(file) {
			file.$update(function() {
				$scope.find();
			}, function(errorResponse) {
				$scope.error = errorResponse.data.message;
			});
		};


	}
]);
