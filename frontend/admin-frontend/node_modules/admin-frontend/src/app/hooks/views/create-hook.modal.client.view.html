<div class="modal-header">
    <h3 class="modal-title">
        <span data-ng-if="addMode">Add</span>
        <span data-ng-if="editMode">Edit</span>
        hook
        <small data-ng-if="new_hook.listingIds.length>1" class="text-warning">for multiple listings</small>
    </h3>
</div>

<form class="modal-body" role="form" name="newHookForm" ng-submit="create()">

    <div class="form-group">
        <label>For the <span data-ng-if="hc.selectedListings.length" data-ng-bind="hc.selectedListings.length"></span>
            listings:</label>
        <ui-select multiple ng-model="hc.selectedListings" class="with-pics">
            <ui-select-match placeholder="All listings">
                <span data-ng-bind="$item.nickname || $item.title" title="{{$item.address.full}}"></span>
            </ui-select-match>
            <ui-select-choices repeat="item in listings"
                               refresh="loadListings($select.search)"
                               refresh-delay="250">
                <img class="pull-right" data-ng-if="item.picture.thumbnail" data-ng-src="{{item.picture.thumbnail}}">
                <div class="truncate">
                    <span data-ng-if="item.nickname" class="label label-info" data-ng-bind="item.nickname"></span>
                    <strong data-ng-bind="item.title"></strong>
                </div>
                <div class="truncate" data-ng-bind="item.address.full"></div>
            </ui-select-choices>
        </ui-select>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            When
        </div>
        <div class="panel-body">
            <div class="form-group">
                <label for="select_events">Event</label>
                <select ng-model="new_hook.event" ng-options="e.name as e.name for e in events" id="select_events"
                        required="required"></select>
            </div>

            <div class="form-group">
                <input type="radio" ng-model="new_hook.when" value="0"> at the event
                <input type="radio" ng-model="new_hook.when" value="1"> after the event

                <span ng-if="fnNewHook.eventCanPast()"><input type="radio" ng-model="new_hook.when" value="-1"> before the event</span>
            </div>
            <div ng-if="new_hook.when!=0">
                <div class="form-group">
                    <input type="number" ng-model="new_hook.when_number" min="0" max="1000">
                    <select ng-model="new_hook.when_type">
                        <option>days</option>
                        <option>hours</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input ng-model="new_hook.atSpecificTime" type="checkbox">
                        At a specific time
                        <span data-ng-show="new_hook.atSpecificTime">:</span>
                    </label>
                    <timepicker data-minute-step="15" data-ng-if="new_hook.atSpecificTime"
                                data-ng-model="new_hook.specificTime"></timepicker>
                </div>
            </div>

            <div class="form-group">
                <div class="dropdown" uib-dropdown>
                    <button class="btn btn-default dropdown-toggle" type="button" uib-dropdown-toggle>
                        Add a filter
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu" role="menu" uib-dropdown-menu>
                        <li role="presentation" data-ng-repeat="filter in filters"><a role="menuitem" tabindex="-1"
                                                                                      href="#"
                                                                                      data-ng-click="addFilter(filter)"
                                                                                      data-ng-bind="filter.displayName"></a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="list-group filters-panel">
                <div data-ng-repeat="filter in new_hook.filters" class="list-group-item">

                    <a class="text text-danger pull-right" data-ng-click="removeFilter(filter)"><i
                            class="fa fa-trash-o"></i></a>
                    <span data-ng-bind="filters[filter.field].displayName" class="filter-input"></span>
                    <span data-ng-if="filtersOptions[filters[filter.field].type]" class="filter-input"
                          data-ng-init="checkGroupsOfFilterOptions(filter, filtersOptions[filters[filter.field].type])">
                        <select data-ng-if="filter.optionsGroupsCount > 1" data-ng-model="filter.optionParams"
                                data-ng-change="castOrSetDefaultSpecificFilter(filter)"
                                data-ng-options="option.displayName group by option.optionGroup for option in filtersOptions[filters[filter.field].type]"></select>
                        <select data-ng-if="filter.optionsGroupsCount <= 1" data-ng-model="filter.optionParams"
                                data-ng-change="castOrSetDefaultSpecificFilter(filter)"
                                data-ng-options="option.displayName for option in filtersOptions[filters[filter.field].type]"></select>
                    </span>
                    <span data-ng-repeat="(index, field) in (filter.optionParams.fields || filter.fields)"
                          class="filter-input" data-ng-if="!filter.optionParams.hideFields">
                        <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'enum'">
                            <select data-ng-if="filter.meta.options || filter.options" data-ng-model="filter[field]"
                                    data-ng-options="item as item for item in (filter.meta.options || filter.options)"
                                    title="Select" required></select>
                            <select data-ng-if="filter.meta.dictionary || filter.dictionary"
                                    data-ng-model="filter[field]"
                                    data-ng-options="item.value as item.title for item in (filter.meta.dictionary || filter.dictionary)"
                                    title="Select" required></select>
                        </span>
                        <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'date'">
                            <g-datepicker data-ng-model="filter[field]" data-input-class="input"></g-datepicker>
                        </span>
                        <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'time'">
                            <span data-ng-if="filter[field]"
                                  data-ng-bind="filter[field] | dateFromString | date: 'shortTime'"></span>
                            <g-time-picker btn-class="btn-xs" ng-model="filter[field]" format="HH:mm"
                                           default-time="'15:00'" minute-step="15"></g-time-picker>
                        </span>
                        <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'number'">
                            <input type="number" data-ng-model="filter[field]">
                        </span>
	                    <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'text'">
		                    <input type="text" data-ng-model="filter[field]">
		                </span>
                        <span data-ng-if="(filter.optionParams.fieldType || filter.type) === 'boolean'">
                            <span>is</span>
                            <label class="switch switch-primary force">
                                <input class="switch-input" data-ng-model="filter[field]" type="checkbox">
                                <span class="switch-label" data-off="No" data-on="Yes"></span>
                                <span class="switch-handle"></span>
                            </label>
                        </span>
                        <span data-ng-if="index < (filter.optionParams.fields.length - 1)">and</span>
                    </span>
                    <span data-ng-bind="filter.optionParams.suffix || filters[filter.field].suffix"
                          class="filter-input"></span>
                </div>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">What</div>
        <div class="panel-body">
            <div class="form-group">
                <label for="select_actions">Action</label>
                <select ng-model="new_hook.action" ng-change="fnNewHook.checkFields()"
                        ng-options="a.name as a.human for a in actions" id="select_actions"
                        required="required"></select>
            </div>
        </div>
    </div>

    <div class="panel panel-default">
        <div class="panel-heading">Options</div>
        <div class="panel-body">
            <div class="form-group" ng-if="fnNewHook.actionCanTarget(null)">
                <label>To</label>
                <select ng-model="new_hook.target">
                    <option ng-show="fnNewHook.actionCanTarget('user')" value="user">User</option>
                    <option ng-show="fnNewHook.actionCanTarget('guest')" value="guest">Guest</option>
                    <option ng-show="fnNewHook.actionCanTarget('contact')" value="contact">Contact</option>
                </select>
            </div>
            <div class="form-group" ng-if="new_hook.target=='user'">
                <label>User:</label>
                <select ng-model="new_hook.userId" ng-options="user._id as user.fullName for user in users"></select>
            </div>
            <div class="form-group" ng-if="new_hook.target=='contact'">
                <label>Contact:</label>
                <select ng-model="new_hook.contact"
                        ng-options="contact._id as contact.fullName for contact in contacts"></select>
            </div>
            <div class="form-group" ng-if="fnNewHook.actionMessageType()">
                <label>Message</label>
                <div ng-if="fnNewHook.actionMessageType('template')">
                    <select ng-model="new_hook.templateId"
                            ng-options="t._id as t.name group by (t.listingId ? 'Listing templates' : t.accountId ? 'User templates' : 'Global templates') for t in templates"
                            class="form-control"></select>
                    <div ng-if="templateHasAttachment(new_hook.templateId)"><span class="label label-info"><i
                            class="glyphicon glyphicon-paperclip"></i> Has attachment</span></div>
                </div>
                <div ng-if="fnNewHook.actionMessageType('plain')">
                    <textarea ng-model="new_hook.message" class="form-control"></textarea>
                </div>
            </div>
            <div class="form-group" data-ng-if="new_hook.action === 'receptionists dashboard'">
                <label>Priority</label>
                <label class="switch switch-md switch-primary force">
                    <input class="switch-input" ng-model="new_hook.params.ticketPriorityShouldBeHigh" type="checkbox">
                    <span class="switch-label" data-off="Regular" data-on="High"></span>
                    <span class="switch-handle"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="form-group" ng-if="new_hook.event !== 'reservation canceled'">
        <label>
            <input ng-model="new_hook.cancelIfReservationGetsCanceled" type="checkbox">
            Should not occur if reservation gets canceled by then
        </label>
    </div>
    <div data-ng-if="fnNewHook.actionMessageType('template') && new_hook.templateId">
        <label>Preview</label>
        <limited-textarea
                ng-model="templateBody(new_hook.templateId)"
                variables-mode="new_hook.action === 'send sms'"
                allowed-variables="'ANY'"
                disabled="true"
                chars-limit-ascii="new_hook.action === 'send sms' ? 306: undefined"
                chars-limit-unicode="new_hook.action === 'send sms' ? 134: undefined"
                readonly="true"></limited-textarea>
        <div ng-messages="newHookForm.$error" role="alert">
            <p ng-message="length" class="alert alert-danger"><strong>Text exceeds max length.</strong></p>
            <p ng-message="wrongVariables" class="alert alert-danger"><strong>Wrong variables.</strong></p>
        </div>
    </div>
    <div class="modal-footer">
        <button type="submit"
                data-ng-disabled="newHookForm.$invalid || newHookForm.$submitted"
                class="btn btn-success" ng-if="addMode" g-log log-title="Add hook"
                log-description="when: {{new_hook.when_type}} what: {{new_hook.action}}">Submit
        </button>
        <button type="button" ng-click="update(new_hook);"
                data-ng-disabled="newHookForm.$invalid || newHookForm.$submitted"
                class="btn btn-success" ng-if="editMode" g-log
                log-title="Update hook" log-description="when: {{new_hook.when_type}} what: {{new_hook.action}}">Update
        </button>
    </div>
</form>