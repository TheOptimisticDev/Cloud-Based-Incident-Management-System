'use strict';

angular.module('accounts').controller('BillingInformationController', [
    '$scope',
    '$uibModal',
    '$timeout',
    'gNotify',
    'Accounts',
    function($scope, $uibModal, $timeout, gNotify, Accounts) {

        if ($scope.account && $scope.account.freezingFlow){
            $scope.freezingFlowReminders = _.filter($scope.account.freezingFlow, function(reminder, key){
                return key !== 'started';
            });
        }

        $scope.addStripeCreditToUser = function() {
            var modalInstance = $uibModal.open({
                templateUrl: 'app/accounts/views/billing/add-credit-form.client.view.html',
                controller: 'AddStripeCreditController',
                backdrop: 'static',
                keyboard: false,
                resolve: {
                    account: function() {
                        return $scope.account;
                    }
                }
            });

            modalInstance.result.then(function(account) { // modal returned success
                gNotify.success('account balance updated');
                //todo: Analytics.track('Billing - Added Credit', {account: $scope.account.name});
            }, function(err) { // modal returned error
                if (err && err.match(/cancel|backdrop click/)) return false;
                gNotify.alert('something went wrong', err);
                $scope.error = err;

                $timeout(function() {
                    delete $scope.error;
                }, 4000);
            });
        };

        $scope.setBillingCycle = function(cycle){
            _.set($scope.account, 'billing.billingCycle', cycle);
            Accounts.updateApi2({accountId: $scope.account._id}, {billing: {billingCycle: cycle}}, function(){
                gNotify.success('saved successfully');
            }, function(err){
                gNotify.alert('something went wrong', err);
            });
        };
    }
]);
