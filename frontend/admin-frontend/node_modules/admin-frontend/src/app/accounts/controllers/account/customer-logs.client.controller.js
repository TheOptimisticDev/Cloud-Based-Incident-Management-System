'use strict';

// Listings controller
angular.module('accounts').controller('AccountLogsController', AccountLogsController);

/** @NgInject **/
function AccountLogsController($scope, Accounts){
	var self = $scope;

	self.selectedListingId = null;
	self.limit = 50;
	self.currentPage = 1;
	self.isLoading = false;


	self.find = findHandler;


	///////////////////////////////////////
	function toggleLoadingIndicator(){
		self.isLoading = !self.isLoading;
	}

	toggleLoadingIndicator();
	Accounts.categories({
		accountId: self.account._id
	}, function(categories){
		categories = categories || []; // Promising array
		var filteredCategories = _.filter(categories, function(elem){
			return typeof elem === typeof '' ? elem : '';
		});
		self.categories = _.map(filteredCategories, function(category){
			return {name: category};
		});
		toggleLoadingIndicator();
	});

	function findHandler(){
		// Reset pagination and list
		self.logs = null;
		toggleLoadingIndicator();
		var selectedCategories = [];
		_.each(self.categories, function(category){
			if(category.active) selectedCategories.push(category.name);
		});

		// Find accounts
		Accounts.logs({
			accountId: self.account._id,
			listingFilterEnabled: self.listingFilterEnabled,
			listingId: self.selectedListingId,
			categories: selectedCategories,
			skip: (self.currentPage - 1) * self.limit,
			limit: self.limit
		}, function(result){
			self.logs = result.logs;
			self.totalCount = result.totalCount;
			toggleLoadingIndicator();
		});
	}


}
