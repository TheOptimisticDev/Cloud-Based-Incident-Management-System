'use strict';

// Listings controller
angular.module('accounts').controller('AccountListingsController', [
    '$scope',
    '$stateParams',
    '$location',
    'Listing',
    'ListingsModalsService',
    'Integrations',
    function($scope, $stateParams, $location, Listing, ListingsModalsService, Integrations) {

        var self = this;

        self.limit = 15;

        //get listings:
        self.load = function(){
            var q = {
                accountId: $stateParams.accountId,
                integrationId: self.filterByIntegrationId,
                q: self.searchTerm,
                fields: '_id picture active isListed instantBookable title isVirtual nickname platforms bedrooms accommodates address roomType integrations',
                sort: 'title',
                limit: self.limit,
                skip: (self.currentPage-1) * self.limit
            };

            if (self.filteredCity){
                q.city = self.filteredCity;
            }
            if (self.filteredListed !== null){
                q.listed = self.filteredListed;
            }
            if (self.filteredActive !== null){
                q.active = self.filteredActive;
            }

            self.listingsRequest = Listing.query(q, function(){
                self.listingsCount = self.listingsRequest.count;
            });

        };

        self.init = function(){
            //defaults
            self.currentPage = 1;
            self.filterByIntegrationId = null;
            self.filteredActive = null;
            self.filteredCity = null;
            self.filteredListed = true;
            self.searchTerm = '';

            //initial load
            self.load();

            //integration //todo: include in api, if included in fields
            Integrations.query({accountId: $stateParams.accountId, fields:'nickname', limit:100}, function(integrations){
                $scope.integrationsById = {};
                _.each(integrations.results, function(integration){
                    $scope.integrationsById[integration._id] = integration;
                });
            });

            self.filterCityOptions = Listing.cities({accountId: $stateParams.accountId});
        };

        self.filterByCity = function(city){
            self.filteredCity = city;
            self.currentPage = 1;
            self.load();
        };

        self.filterByActive = function(state){
            self.filteredActive = state;
            self.currentPage = 1;
            self.load();
        };

        self.filterByListed = function(state){
            self.filteredListed = state;
            self.currentPage = 1;
            self.load();
        };

        self.filterByIntegration = function(integration){
            self.filterByIntegrationId = integration ? integration._id : null;
            self.currentPage = 1;
            self.load();
        };

    }
]);
