/* global  */
'use strict';

angular.module('accounts')
    .controller('NewInvoiceItemController', function($scope, formData, ReservationsInvoiceItems, notify) { // expecting formData to contain accountId, currencies(optional), reservation(optional)
        $scope.newItem = {
            currency: 'USD'
        };
        $scope.currencies = formData.currencies || ['USD'];
        $scope.addToTitle = (formData.reservation) ? ' for reservation #' + formData.reservation.confirmationCode : '';
        $scope.save = function() {

            $scope.disableBtns = true;

            if (!$scope.newItem || !$scope.newItem.amount) {
                $scope.disableBtns = false;
                return false;
            }

            $scope.newItem.accountId = formData.accountId;
            if (formData.reservation) {
                $scope.newItem.reservationId = formData.reservation._id;
            }

            var reservationInvoiceItem = new ReservationsInvoiceItems($scope.newItem);
            reservationInvoiceItem.save(function(invoiceItem) {
                notify({
                    message: 'Invoice item created successfully',
                    classes: 'alert-success'
                });
                $scope.disableBtns = false;
                $scope.$loading = false;
                $scope.$close(invoiceItem);
            }, function() {
                notify({
                    message: 'Invoice item could not be created',
                    classes: 'alert-danger'
                });
                $scope.disableBtns = false;
                $scope.$loading = false;
            });
        };

        $scope.$watch('newItem.amount', function() {
            $scope.requireRefundReasonField = $scope.newItem.amount && $scope.newItem.amount < 0 ? true : false;
        });

        $scope.cancel = function() {
            $scope.$dismiss('cancel');
        };
    });
