'use strict';

angular.module('research').controller('researchConversationsListController', [
    '$scope',
    'notify',
    '$rootScope',
    '$filter',
    function($scope, notify, $rootScope, $filter) {
        // Research modal controller logic
        var trustedHtmlFilter = $filter('trustedHtml');

        /**
         * return conversation title for conversation
         * @param conversation
         * @returns {String}
         */
        function getConversationTitle(conversation) {
            var conversationTitle = conversation.conversationWith;
            if(conversationTitle === 'Guest') {
                conversationTitle += ': ' + conversation.guest.fullName;
            }
            return conversationTitle;
        }


        // public

        $scope.init = function (conversationsLists, query, metadata) {

            $scope.forOtherListings =     conversationsLists[0] || [];
            $scope.forListing =           conversationsLists[1] || [];

            if(!metadata.listingId) {
                $scope.isResearchNotIncludingListing = 1;
            }

            // run for all conversations
            _.each([].concat($scope.forOtherListings, $scope.forListing), function (conversation) {
                conversation.conversationTitle = getConversationTitle(conversation);
                conversation.subject = trustedHtmlFilter(conversation.subject || '');

                _.each(conversation.thread, function (post) {
                    post.body = post.body || '';
                });
                // transform this object to an array and flatten it
                conversation.queryFoundInThread = _.flatten(_.map(conversation.queryFoundInThread, function(row) {return row;}));

                conversation.queryFoundInThread = _.map(conversation.queryFoundInThread, function (sentence) {
                    return trustedHtmlFilter(sentence || '');
                });
            });
        };

        $scope.openConversationThreadLog = function(conversation) {
            $rootScope.$broadcast('research:view:conversation', conversation);
        };
    }
]);
