'use strict';

// Inbox controller
angular.module('inbox').controller('PassTicketModalController', [
    '$scope',
    'Authentication',
    'Employees',
    'InboxTicket',
    '$uibModalInstance',
    'gNotify',
    'ticketId',
	function($scope, Authentication, Employees, InboxTicket, $uibModalInstance, gNotify, ticketId) {

        $scope.passData = {
            passTo: null,
            reason: null
        };

        // get active employees in inbox
        Employees.listOfEmployeesInInbox(function(activeEmployees) {
            $scope.activeEmployees = _.filter(activeEmployees, function(user) {
                return user._id !== Authentication.userId();
            });
        });

        // get current ticket
        if(ticketId) {
            $scope.passData._id = ticketId;
        } else {
            $scope.ticket = InboxTicket.get({}, function() {
                $scope.passData._id = $scope.ticket._id;
            });
        }

        $scope.save = function() {
            if(!$scope.passData.reason) {
                gNotify.alert('Please fill a reason to pass');
                return;
            }
            $scope.disableButtons = true;
            InboxTicket.pass($scope.passData, function() {

                //todo: Analytics.track('Ticket - Passed', _.extend({}, $scope.ticket ? $scope.ticket.toJSON() : ticketId, $scope.passData));
                gNotify.success('Ticket passed successfully');
                $uibModalInstance.close($scope.passData);
            }, function() {
                $scope.disableButtons = false;
                gNotify.alert('Failed to pass ticket');
            });
        };

        $scope.cancel = function() {
            $uibModalInstance.dismiss(false);
        };
    }
]);
