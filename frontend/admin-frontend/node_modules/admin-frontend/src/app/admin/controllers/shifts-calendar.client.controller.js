/* global _, moment */
'use strict';

angular.module('admin').controller('ShiftsCalendarController', [
    '$scope',
    'Authentication',
    'Shifts',
    function($scope, Authentication, Shifts) {



        // Set up ui-calendar configuration
        $scope.uiCalendar = {
            defaultView: 'agendaWeek',
            allDaySlot: false,
            allDayDefault: false,
            editable: false,
            ignoreTimezone: false
        };

        // Populate the calendar's events objects
        $scope.calendarEvents = [function(start, end, timezone, renderCalendar) {
            $scope.employeesShifts = Shifts.query({
                start: moment(start).toDate(),
                end: moment(end).toDate()
            }, function() {
                var shifts = [];
                _.each($scope.employeesShifts, function(employee) {
                    var color = Math.floor(Math.random() * 16777215);
                    var textColor = color < 16777215 / 2 ? '#FFF' : '#000';
                    color = '#' + color.toString(16);

                    _.each(employee.shifts, function(shift) {

                        var eventTitle = employee.username + '\n' +
                        moment(shift.checkIn).format('hh:mm');
                        if (shift.checkOut) {
                            eventTitle += '\n' + moment(shift.checkOut).format('hh:mm') + '\n';
                            var duration = moment.duration(moment(shift.checkOut)-moment(shift.checkIn));
                            eventTitle += '(' + duration.hours() + ':' + duration.minutes() + ')';
                        }

                        // build the ui.calendar event object
                        shifts.push({
                            start: shift.checkIn, //moment(shift.checkIn).unix(),
                            end: shift.checkOut, //moment(shift.checkOut).unix(),
                            title: eventTitle,
                            color: color,
                            textColor: textColor
                        });
                    });
                });

                renderCalendar(shifts);
            });
        }];
    }
]);
