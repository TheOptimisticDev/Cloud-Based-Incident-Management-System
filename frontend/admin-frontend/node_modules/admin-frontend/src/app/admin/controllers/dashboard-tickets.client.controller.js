'use strict';

angular.module('dashboard').controller('DashboardTicketsController', [
    '$scope',
    'DashboardTickets',
    'Employees',
    'gNotify',
    '$timeout',
    'OnlineReceptionists',
    '$rootScope',
	function($scope, DashboardTickets, Employees, gNotify, $timeout, OnlineReceptionists, $rootScope) {

        $scope.query = {
            limit: 50
        };
        $scope.currentPage = 1;
        $scope.totalCount = 0;
        $scope.canAssignTickets = false;

        $scope.init = init;
        $scope.find = find;
        $scope.updateEmployeesInInbox = updateEmployeesInInbox;
        $scope.assignTicket = assignTicket;
        $scope.completeTicket = completeTicket;
        $scope.setTicketPriority = setTicketPriority;

        ////////////////////////

        function init(){
            $scope.find();
            DashboardTickets.getReviewsCount(function(response){
                $scope.reviewsCount = response.count;
            });
            $scope.activeReceptionists = OnlineReceptionists.all;
            if ($rootScope.employee){
                if ($rootScope.employee.$resolved){
                    $scope.canAssignTickets = _.intersection($rootScope.employee.roles, ['receptionists-ticket-assigner', 'admin']).length>0;
                } else {
                    $rootScope.employee.$promise.then(function(){
                        $scope.canAssignTickets = _.intersection($rootScope.employee.roles, ['receptionists-ticket-assigner', 'admin']).length>0;
                    });
                }
            }
        }

        function find() {
            // clear results
            $timeout(function(){$scope.tickets = [];});

            // Set pagination
            $scope.query.skip = ($scope.currentPage - 1) * $scope.query.limit;
            $scope.query.isGoldfish = $scope.isGoldfish;

            // Get all reservations matching the current query
            DashboardTickets.query($scope.query, function(response) {
                $scope.tickets = response.tickets;
                $scope.totalCount = response.totalCount;
            });
        }


        function updateEmployeesInInbox() {
            $scope.usersInInbox = Employees.listOfEmployeesInInbox();
        }

        // assign a ticket to user
        function assignTicket(ticket, username) {
            ticket = new DashboardTickets(ticket);
            ticket.$assign({
                assignedTo: username
            }, angular.noop, function() {
                gNotify.alert('failed to assign the ticket');
            });
        }

        // mark ticket as completed
        function completeTicket(ticket) {
            ticket = new DashboardTickets(ticket);
            ticket.$complete({
                dashboardTicket: ticket._id
            }, function() {
                gNotify.success('ticket marked as completed successfully');
                $scope.find();
            }, function() {
                gNotify.alert('failed to mark ticket as completed');
            });
        }

        // set new priority to ticket
        function setTicketPriority(ticket, priority) {
            ticket = new DashboardTickets(ticket);
            ticket.$setPriority({
                priority: priority
            }, function() {
                gNotify.success('ticket priority changed successfully');
                $scope.find();
            }, function() {
                gNotify.alert('failed to set ticket priority');
            });
        }
	}
]);
