'use strict';

angular.module('integrations').controller('CreateNewRentalsUnitedController', [
    'Integrations',
    'accountId',
    'notify',
    '$uibModal',
    '$uibModalInstance',
    '$state',
    function(Integrations, accountId, notify, $uibModal, $uibModalInstance, $state) {

        var self = this;

        self.existingAccount = false;

        self.submit = function(frm){
            if (frm.$invalid) return;

            var integration = new Integrations({
                accountId: accountId,
                platform: 'rentalsUnited'
            });

            if (self.existingAccount){
                integration.rentalsUnited = {
                    username: self.username,
                    password: self.password
                };
            }

            integration.$create(function(integration){
                //close this modal
                $uibModalInstance.close();

                //either go syncing listings
                if (self.existingAccount){
                    $uibModal.open({
                        templateUrl: 'app/integrations/views/create-rentals-united2.modal.client.view.html',
                        controller: 'CreateNewRentalsUnited2Controller as ru',
                        resolve: {
                            integration: function() {
                                return integration;
                            },
                            accountId: function(){
                                return accountId;
                            }
                        }
                    });
                }
                //or to the integration page
                else {
                    $state.go('account.integration', {integrationId: integration._id});
                }
            }, function(){
                notify({
                    message:'Error',
                    classes: 'alert-danger'
                });
                frm.$setPristine();
            });
        };


    }
]);
