'use strict';

angular.module('integrations').controller('CreateNewRentalsUnited2Controller', [
    'Integrations',
    'accountId',
    'integration',
    'notify',
    '$uibModal',
    '$uibModalInstance',
    'Listing',
    '$state',
    function(Integrations, accountId, integration, notify, $uibModal, $uibModalInstance, Listing, $state) {

        var self = this;

        self.listings = Listing.query({
            accountId: accountId,
            fields: '_id title nickname address.full'
        });

        self.submit = function(frm){
            var onError = function(){
                notify({
                    message:'Error',
                    classes: 'alert-danger'
                });
                frm.$setPristine();
            };
            async.each(self.listings, function(listing, done){
                if (listing.externalId){
                    Listing.addIntegration({listingId: listing._id}, {
                        _id: integration._id,
                        rentalsUnited: {
                            id: listing.externalId
                        }
                    }, function(){
                        done();
                    }, function(err){
                        done(err);
                    });
                } else {
                    done();
                }
            }, function(err){
                if (err){
                    return onError();
                }

                //import listings
                Integrations.importExternalListings({integrationId: integration._id}, {}, function(){
                    $uibModalInstance.close();
                    $state.go('account.integration', {integrationId: integration._id});
                }, onError);

            });
        };

    }
]);
