'use strict';

angular.module('dashboard').controller('GuestCtrl', [
    '$stateParams',
    '$scope',
    'guestId',
    'Guest',
    'SweetAlert',
    '$uibModalInstance',
    function($stateParams, $scope, guestId, Guest, SweetAlert, $uibModalInstance) {

        var self = this;

        self.editMode = false;

        var reformatEmailsAndPhones = function(){
            self.emails = _.map(self.guest.emails, function(email){
                    return { value: email };
                }) || [];
            self.phones = _.map(self.guest.phones, function(phone){
                    return { value: phone };
                }) || [];
        };

        self.init = function(){
            self.guest = Guest.get({guestId: guestId || $stateParams.guestId}, function(){
                reformatEmailsAndPhones();
            });
        };

        self.setValue = function(path, value, frm){
            _.set(self.guest, path, value);
            if (frm){
                frm.$setDirty();
            }
        };

        self.removeItemFromArray = function(type, item, frm){
            self[type + 's'] = _.reject(self[type + 's'], {'value': item});
            if (self.guest[type] === item){
                self.guest[type] = self[type + 's'][0].value;
            }
            if (frm){
                frm.$setDirty();
            }
        };

        self.addEmail = function(){
            self.emails.push({value:''});
        };

        self.addPhone = function(){
            self.phones.push({value:''});
        };

        self.close = function(){
            $uibModalInstance.dismiss();
        };

        self.isDuplication = function(arr){
            if (!arr || !arr.length) return false;
            return _.uniqBy(arr, 'value').length !== arr.length;
        };

        self.submitForm = function(frm){
            self.guest.emails = _.compact(_.map(self.emails, 'value'));
            self.guest.phones = _.compact(_.map(self.phones, 'value'));

            if (!self.guest.email && self.guest.emails){
                self.guest.email = self.guest.emails[0];
            }

            self.guest.$update(function(){
                if (frm) {
                    frm.$setPristine();
                    $scope.$close(true);
                }
            }, function(err){
                SweetAlert.swal(err.data, 'Error', 'error');
                if (frm) {
                    frm.$setPristine();
                }
            });
        };

    }
]);
