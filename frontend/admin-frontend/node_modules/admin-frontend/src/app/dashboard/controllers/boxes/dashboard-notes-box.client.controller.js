'use strict';

// Dashboard controller
angular.module('dashboard').controller('DashboardNotesBoxController', [
    '$scope',
    '$stateParams',
    '$location',
    'Authentication',
    'InternalNotes',
    function($scope, $stateParams, $location, Authentication, InternalNotes) {
        var currentValueOfNotes,
            notesBeforeFocus;

        var self = this;

        self.init = function(){
            var reservationId = $scope.reservation._id;

            if (!reservationId) return;

            if ($scope.internalNotes && reservationId === self.reservationId) return;

            $scope.internalNotes = InternalNotes.get({
                reservationId: reservationId
            });
            self.reservationId = reservationId;
        };

        $scope.$watch('reservation._id', self.init);

        function createEmployeeTimestamp() {
            var employee = Authentication.getEmployee().username;
            var date = moment().format('MM/DD HH:mm');
            return '[' + employee + ' ' + date + ']: ';
        }

        self.onFocusIn = function() {
            $scope.internalNotes.notes = $scope.internalNotes.notes || '';
            notesBeforeFocus = $scope.internalNotes.notes;

            if ($scope.internalNotes.notes.trim() !== '') {
                $scope.internalNotes.notes += '\n';
            }

            $scope.internalNotes.notes += createEmployeeTimestamp();
            currentValueOfNotes = $scope.internalNotes.notes;
        };

        self.onFocusOut = function() {
            if ($scope.internalNotes.notes === currentValueOfNotes) {
                $scope.internalNotes.notes = notesBeforeFocus; // remove the signature we've added on focusing the notes
                return;
            }

            // save internal notes
            $scope.internalNotes.$update();
        };
    }
]);
