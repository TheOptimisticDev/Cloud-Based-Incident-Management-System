'use strict';

// Dashboard controller
angular.module('dashboard').controller('DashboardListingBoxController', [
    '$scope',
    '$stateParams',
    '$location',
    '$interval',
    '$uibModal',
    'Listing',
    'ListingsModalsService',
    function($scope, $stateParams, $location, $interval, $uibModal, Listing, ListingsModalsService) {

        var self = this;

        self.now = new Date();

        self.init = function(){
            // the parent view that holds the listing props can be one of those:
            var parentObj = $scope.reservation || $scope.conversation || $scope.notification || $scope.ticket;

            var onReady = function(){
                var listingId = parentObj.listingId || (parentObj.listing ? parentObj.listing._id : null);
                if (!listingId) return;

                //don't load same customer again
                if (self.listing && listingId === self.listing._id) return;

                self.listing = Listing.get({
                    listingId: listingId,
                    fields: 'active isListed isVirtual title picture.thumbnail timezone address nickname roomType propertyType accommodates guestsIncludedInRegularFee bedrooms beds prices terms platforms integrations'
                }, function(listing) {
                    self.boxStyle = {
                        'dashboard-box-color-red': !listing.active || !listing.isListed
                    };
                    $scope.listingIntegration = _.find(listing.integrations, {'_id': $scope.reservation.integration._id});
                });
            };

            //different promise object for reservations
            var waitForObj = $scope.reservations && $scope.reservations.length ? $scope.reservations : parentObj;
            if (!waitForObj) waitForObj = {};

            //run when ready
            if (waitForObj.$resolved){
                onReady();
            } else if (waitForObj.$promise) {
                waitForObj.$promise.then(onReady);
            }
        };

        $scope.$watch('reservation._id', self.init);

        self.openCalendar = function() {
            $uibModal.open({
                windowClass: 'calendar-modal',
                templateUrl: 'app/listings/views/listing/listing-calendar.client.view.html',
                size: 'lg',
                controller: function($scope) {
                    $scope.listing = self.listing;
                }
            });
        };

        self.openListingModal = function() {
            $uibModal.open({
                windowClass: 'modal-padded',
                templateUrl: 'app/listings/views/listing/receptionists/main.client.view.html',
                size: 'lg',
                controller: function($scope) {
                    $scope.listingId = self.listing._id;
                }
            });
        };

        self.openGallery = function(){
            ListingsModalsService.openListingGalleryModal(self.listing._id);
        };
    }
]);
