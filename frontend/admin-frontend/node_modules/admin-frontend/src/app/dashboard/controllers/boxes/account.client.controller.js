'use strict';

// Dashboard controller
angular.module('dashboard').controller('DashboardAccountBoxController', [
    '$scope',
    '$stateParams',
    '$location',
    '$interval',
    '$uibModal',
    'Accounts',
    'Listing',
    'Integrations',
    'ResearchModalService',
    function($scope, $stateParams, $location, $interval, $uibModal, Accounts, Listing, Integrations, ResearchModalService) {

        var self = this;

        self.init = function(){
            // the parent view that holds the listing props can be one of those:
            var parentObj = $scope.reservation || $scope.conversation || $scope.notification || $scope.ticket;

            var onReady = function(){
                var accountId = parentObj.accountId;
                if (!accountId) return;

                //don't load same account again
                if (self.account && accountId === self.account._id) return;

                self.account = Accounts.get({
                    accountId: accountId,
                    fields: 'active name integrations accountCategorization'
                }, function() {
                    if ($scope.reservation && $scope.reservation.integration && $scope.reservation.integration._id) {
                        self.integration = Integrations.get({integrationId: $scope.reservation.integration._id, fields: 'nickname presentableName credentials'});
                    }
                });

                if (parentObj.listingId){
                    self.listing = Listing.get({
                        listingId: parentObj.listingId,
                        fields: 'receptionistsService.receptionDesk.whiteLabel receptionistsService.receptionDesk.customImpersonation receptionistsService.receptionDesk.customSignature'
                    });
                }
            };

            //different promise object for reservations
            var waitForObj = $scope.reservations && $scope.reservations.length ? $scope.reservations : parentObj;
            if (!waitForObj) waitForObj = {};

            //run when ready
            if (waitForObj.$resolved){
                onReady();
            } else if (waitForObj.$promise) {
                waitForObj.$promise.then(onReady);
            }

        };

        $scope.$watch('reservation._id', self.init);

        self.toggleCredentials = function() {
            self.displayCredentials = !self.displayCredentials;
        };

        self.openMultiCalendar = function() {
            $uibModal.open({
                windowClass: 'multi-calendar-modal',
                templateUrl: 'app/accounts/views/account/multi-calendar.client.view.html',
                size: 'lg',
                controller: function($scope) {
                    $scope.accountId = self.account._id;
                }
            });
        };

        self.openResearchModal = function() {
            ResearchModalService.open({account: self.account, listing: $scope.listing});
        };
    }
]);
