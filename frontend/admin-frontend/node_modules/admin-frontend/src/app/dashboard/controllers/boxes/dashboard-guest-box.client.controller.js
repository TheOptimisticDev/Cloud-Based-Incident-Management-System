'use strict';

// Dashboard controller
angular.module('dashboard').controller('DashboardGuestBoxController', [
    '$scope',
    '$uibModal',
    'Reservations',
    'notify',
	function($scope, $uibModal, Reservations, notify) {

        var self = this;

        self.initReady = function(){
            self.guest = {$resolved: false};
            Reservations.get({
                reservationId: $scope.reservation._id,
                fields: 'guest'
            }, function(reservation) {
                self.reservation = { _id: reservation._id }; //temp
                self.guest = reservation.guest || {};
                self.guest.$resolved = true;
            });
        };

        self.init = function(){
            if (!$scope.reservation || !$scope.reservation._id) return;
            if (self.reservation && $scope.reservation._id === self.reservation._id) return;

            //run when ready
            if ($scope.reservations){
                if (!$scope.reservations.$promise && $scope.reservations.length) {
                 self.initReady();
                }else{
					$scope.reservations.$promise.then(self.initReady);

                }
            }

        };

        $scope.$watch('reservation._id', self.init);

        self.verify = function(){
            $scope.ticket.askedToVerify = true;
			Reservations.verifyGuest({
                reservationId: $scope.reservation._id
            }, function() {
                notify({
                    message: 'Ok! System will start tracking guest verification status',
                    classes: 'alert-success'
                });

				Reservations.log({
                    reservationId: $scope.reservation._id
                },{
					event: 'Set to track ID verification of guest'
				});
                // save the change in the ticket (ticket.askedToVerify)
                $scope.save($scope.ticket);
            }, function() {
                notify({
                    message: 'Action failed',
                    classes: 'alert-danger'
                });
                delete $scope.ticket.askedToVerify;
            });
        };

        self.openGuest = function(){
            $uibModal.open({
                templateUrl: 'app/dashboard/views/modals/guest.modal.client.view.html',
                controller: 'GuestCtrl as guestCtrl',
                resolve: {
                    guestId: function(){
                        return self.guest._id;
                    }
                },
                size: 'lg'
            }).result.then(function(){
                self.initReady();
            });
        };
	}
]);
