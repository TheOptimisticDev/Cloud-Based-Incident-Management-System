'use strict';

/**
 * this controller can be opened from $uibModal only. please don't forget to send 'formData' to the modal.
 * data that should be sent at formData: {accountId, reservationId}
 */
angular.module('dashboard').controller('SpecialOfferController', [
    '$scope',
    'formData',
    'Listing',
    '$uibModalInstance',
    'notify',
    'Reservations',
    'CommonService',
    function($scope, formData, Listing, $uibModalInstance, notify, Reservations, CommonService) {
        $scope.guestsOptions = _.range(1, 16);
        $scope.specialOffer = formData;

        $scope.save = function() {
            // Validates listing's existance
            if (!$scope.specialOffer.listing) {
                return notify({
                    message: 'Please choose listing',
                    classes: 'alert-danger'
                });
            }

            // Validates dates existence
            if (!($scope.specialOffer.startDate && $scope.specialOffer.endDate)) {
                return notify({
                    message: 'Please fill special offer date-range',
                    classes: 'alert-danger'
                });
            }

            // Validates endDate after startDate
            if (($scope.specialOffer.endDate - $scope.specialOffer.startDate) <= 0) {
                return notify({
                    message: 'Please enter valid date-range',
                    classes: 'alert-danger'
                });
            }

            // Validates price
            if (!$scope.specialOffer.price) {
                return notify({
                    message: 'Please fill price',
                    classes: 'alert-danger'
                });
            }

            CommonService.confirm().then(function() {
                // The listing appear as an object, and should not be sent to the API, but only the listingId
                var dataForApi = angular.extend({}, $scope.specialOffer);
                dataForApi.listingId = dataForApi.listing._id;

                // Remove the listing for network optimization
                delete dataForApi.listing;

                dataForApi.startDate = moment(dataForApi.startDate).format('YYYY/MM/DD');
                dataForApi.endDate = moment(dataForApi.endDate).format('YYYY/MM/DD');

                Reservations.specialOffer({
                    reservationId: dataForApi.reservationId
                }, dataForApi, function(){
                    notify({
                        message: 'Special Offer was added to queue',
                        classes: 'alert-success'
                    });

                    Reservations.log({ reservationId: dataForApi.reservationId },{
                        event: 'Special offer was sent to the guest',
                        description: 'between ' + dataForApi.startDate + ' to ' + dataForApi.endDate + ', for $' + dataForApi.price
                    });
                    $uibModalInstance.dismiss();
                }, function(){
                    notify({
                        message: 'Could not save Special-Offer',
                        classes: 'alert-danger'
                    });
                });
            });
        };

        $scope.cancel = function() {
            $uibModalInstance.dismiss();
        };

        $scope.loadListings = function(q, ids){
            return Listing.query({
                accountId: formData.accountId,
                fields:'_id title address.full picture.thumbnail nickname',
                q: q,
                ids: ids,
                nids: ids ? null : _.get($scope, 'selectedListing._id'),
                limit: ids ? 100 : 10,
                pmsActive:true,
                sort: 'nickname title'
            }, function(listings){
                $scope.listings = listings.results;
            });
        };

        $scope.loadListings(null, formData.listingId).$promise.then(function(){
            $scope.specialOffer.listing = _.find($scope.listings, function(listing) {
                return listing._id === formData.listingId;
            });
        });
    }
]);
