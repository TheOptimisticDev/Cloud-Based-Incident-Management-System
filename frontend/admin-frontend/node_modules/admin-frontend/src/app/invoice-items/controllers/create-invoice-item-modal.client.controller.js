'use strict';

// create invoice item modal
angular.module('invoice-items').controller('CreateInvoiceItemModalController', [
    '$scope',
    'formData',
    'Reservations',
    '$uibModalInstance',
    'notify',
    'ReservationsInvoiceItems',
    'AccountsInvoiceItems',
    function ($scope, formData, Reservations, $uibModalInstance, notify, ReservationsInvoiceItems, AccountsInvoiceItems) {

        // decide which service this modal should use to save the new invoice item
        var InvoiceItem = formData.reservationId ? ReservationsInvoiceItems : AccountsInvoiceItems;

        /**
         * watch on amount change to detect refunds
         */
        function subscribeToRelevantEvents() {
            $scope.$watch('newItem.amount',function() {
                $scope.requireRefundReasonField = $scope.newItem.amount && $scope.newItem.amount < 0 ? true : false;
            });
        }

        /**
         * added title for the modal, and also create reservation-invoice-item instead customer-invoice-item
         */
        function getReservationForTitle() {
            if(formData.reservationId) {
                $scope.reservation = Reservations.get({
                    reservationId: formData.reservationId,
                    fields: 'confirmationCode'
                }, function () {
                    $scope.addToTitle = ' for reservation #' + $scope.reservation.confirmationCode;
                });
            }
        }

        /**
         * initialize the scope
         */
        (function init() {
            $scope.newItem = new InvoiceItem({
                currency: 'USD',
                accountId: formData.accountId,
                reservationId: formData.reservationId
            });
            $scope.currencies = formData.currencies || ['USD'];

            subscribeToRelevantEvents();
            getReservationForTitle();
        })();

        /**
         * save the invoice item
         * @returns {boolean}
         */
        $scope.save = function () {
            $scope.disableBtns = true;

            if (!$scope.newItem || !$scope.newItem.amount) {
                $scope.disableBtns = false;
                return false;
            }

            $scope.newItem.$save({}, function(invoiceItem) {
                notify({message: 'Invoice item created successfully', classes: 'alert-success'});
                $scope.disableBtns = false;
                $scope.$loading = false;
                $uibModalInstance.close(invoiceItem);
            }, function() {
                notify({message: 'Invoice item could not be created', classes: 'alert-danger'});
                $scope.disableBtns = false;
                $scope.$loading = false;
            });
        };

        /**
         * close the modal without saving
         */
        $scope.cancel = function () {
            $uibModalInstance.dismiss('cancel');
        };
    }
]);
