'use strict';

angular.module('reservations').controller('ReservationCustomFieldsController', [
    'Accounts',
    'User',
    'Contact',
    '$stateParams',
    '$scope',
    function(Account, User, Contact, $stateParams, $scope) {

        var self = this;

        self.init = function(reservation){
            self.reservation = reservation || {};
            if (!self.reservation.accountId) self.reservation.accountId = $stateParams.accountId || $scope.accountId;
            Account.get({accountId: self.reservation.accountId, fields: 'customFields'}, function(account){
                self.customFields = _.filter(account.customFields || [], {'object': 'reservation'});

                var userField = _.find(self.customFields, {'type': 'user'});
                if (userField){
                    self.users = User.query({accountId: self.reservation.accountId, fields:'fullName'}, function(){
                        _.each(self.customFields, function(field){
                            if (field.type==='user' && field.value){
                                var user = _.find(self.users.results, {'_id': field.value});
                                field.displayValue = user ? user.fullName : 'Unknown user';
                            }
                        });
                    });
                }
                var contactField = _.find(self.customFields, {'type': 'contact'});
                if (contactField){
                    self.contacts = Contact.query({accountId: self.reservation.accountId, fields:'fullName'}, function(){
                        _.each(self.customFields, function(field){
                            if (field.type==='contact' && field.value){
                                var contact = _.find(self.contacts.results, {'_id': field.value});
                                field.displayValue = contact ? contact.fullName : 'Unknown contact';
                            }
                        });
                    });
                }

                _.each(self.reservation.customFields || [], function(reservationField){
                    var field = _.find(self.customFields, {'_id': reservationField.fieldId});
                    if (field){
                        field.value = reservationField.value;
                    } else {
                        //deleted field, should not happen, because when deleting a custom field, it deletes the data as well.
                    }
                });
            });
        };

        self.submitCustomFields = function(submit, frm){
            _.each(self.customFields, function(field){
                var currentValue = _.find(self.reservation.customFields || [], {'fieldId': field._id});
                if (currentValue){
                    //if value changed (otherwise do nothing)
                    if (currentValue.value !== field.value) {
                        currentValue.value = field.value;
                    }
                } else if (field.value) {
                    //new field!
                    if (!self.reservation.customFields) self.reservation.customFields = [];
                    self.reservation.customFields.push({
                        fieldId: field._id,
                        value: field.value
                    });
                }
            });

            submit(frm, 'customFields');
        };

    }
]);
